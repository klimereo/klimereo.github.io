<!DOCTYPE html>
<html>
<head>
  <title>Balanced Redirect</title>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>
</head>
<body>
<script>
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  async function redirectUser() {
    try {
      const snapshot = await db.collection('links').get();
      if (snapshot.empty) {
        console.error('No links found');
        return;
      }

      // Find link with lowest count
      let minLink = null;
      snapshot.forEach(doc => {
        const data = doc.data();
        if (!minLink || data.count < minLink.count) {
          minLink = { id: doc.id, ...data };
        }
      });

      if (!minLink) return;

      // Increment count
      await db.collection('links').doc(minLink.id)
              .update({ count: firebase.firestore.FieldValue.increment(1) });

      // Redirect
      window.location.href = minLink.url;

    } catch (err) {
      console.error("Error redirecting:", err);
    }
  }

  // Run on page load
  redirectUser();
</script>
</body>
</html>
