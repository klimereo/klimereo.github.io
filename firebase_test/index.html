<!DOCTYPE html>
<html>
<head>
  <title>Redirecting...</title>
  <script src="https://www.gstatic.com/firebasejs/10.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.15.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAx5puOlTEABP6OAhWPY35qtViStTovrQo",
      authDomain: "symco-7af01.firebaseapp.com",
      projectId: "symco-7af01",
      storageBucket: "symco-7af01.firebasestorage.app",
      messagingSenderId: "907225895613",
      appId: "1:907225895613:web:857bcb53dfbde37f781dd4"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function redirectUser() {
      try {
        const snapshot = await db.collection("links").get();

        if (snapshot.empty) {
          document.body.innerText = "No links available.";
          return;
        }

        // Find links with the minimum count
        let minCount = Infinity;
        let candidates = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.count < minCount) {
            minCount = data.count;
            candidates = [doc];
          } else if (data.count === minCount) {
            candidates.push(doc);
          }
        });

        // Pick a random link among the ties
        const selectedDoc = candidates[Math.floor(Math.random() * candidates.length)];

        // Increment count (not fully atomic, but okay for low traffic)
        selectedDoc.ref.update({ count: selectedDoc.data().count + 1 });

        // Redirect
        window.location.href = selectedDoc.data().url;

      } catch (err) {
        console.error(err);
        document.body.innerText = "Redirect failed.";
      }
    }

    window.onload = redirectUser;
  </script>
</head>
<body>
  Redirecting...
</body>
</html>
